import { useEffect, useRef } from 'react'
import { useMapbox } from '@carbonplan/maps'
import { v4 as uuidv4 } from 'uuid'

const updatePaintProperty = (map, ref, key, value) => {
    const { current: id } = ref
    if (map.getLayer(id)) {
        map.setPaintProperty(id, key, value)
    }
}

const TempLayer = ({ 
    id, 
    variable,
    color,
    opacity,
    width,
}) => {
    const { map } = useMapbox()
    const removed = useRef(false)

    const sourceIdRef = useRef()
    const layerIdRef = useRef()

    let jsonString = '{"coordinates": [[-83.1308623943533, 41.93802894380099], [-83.12344864999994, 41.920336405000015], [-83.09737788899994, 41.87576548300011], [-83.06841324999988, 41.847731018999994], [-82.98379309099988, 41.80806935700012], [-82.86522151699995, 41.752491353000025], [-82.7111223959999, 41.680247701000084], [-82.6669132079999, 41.66908559200006], [-82.45131913299991, 41.67190195700003], [-82.42486079999992, 41.676811219000044], [-82.28135534699993, 41.74329294900012], [-82.1377465409999, 41.809800517000085], [-81.99424108899993, 41.87620473300002], [-81.85073563599994, 41.9427123010001], [-81.70728186099987, 42.00921986900006], [-81.56372473199994, 42.07567576100003], [-81.42021927899995, 42.14215749099999], [-81.27666215099995, 42.20866506000006], [-81.14788448099995, 42.22825042699999], [-81.01915848899998, 42.24780995700009], [-80.89038081899989, 42.267447002000026], [-80.76165482699992, 42.287032369000045], [-80.63287715699994, 42.30664357500008], [-80.52023319740414, 42.32378209856495], [-80.52023319740414, 42.21938885301313], [-80.52023319740414, 42.11457928340718], [-80.52023319740414, 42.00974529900634], [-80.52023319740414, 41.90488689981055], [-80.52023319740414, 41.800028502413454], [-80.52023319740414, 41.69517010321766], [-80.52023319740414, 41.59033611881682], [-80.52023319740414, 41.485526549210874], [-80.52023319740414, 41.38066815001508], [-80.52023319740414, 41.27583416651356], [-80.52023319740414, 41.17097576821709], [-80.52023319740414, 41.0661661968125], [-80.52023319740414, 40.96133221331098], [-80.52023319740414, 40.85644940021962], [-80.52023319740414, 40.751615415818776], [-80.52023319740414, 40.6467814323172], [-80.53571171332487, 40.643509946926486], [-80.58043827490644, 40.6191202988627], [-80.59728397797318, 40.626639829964176], [-80.62252811867774, 40.62600506418232], [-80.64828495478685, 40.61938885351276], [-80.66637577462228, 40.60886639346927], [-80.67684940777394, 40.58879803280297], [-80.66950077484086, 40.57156170470887], [-80.63629765021636, 40.537162291106824], [-80.61408085324877, 40.50366619703732], [-80.60512089241524, 40.48594158833362], [-80.60150761068769, 40.47139080674032], [-80.60665897772964, 40.448905455122656], [-80.62709354862835, 40.40969647081545], [-80.62887577469724, 40.38638104135197], [-80.62609257171482, 40.386527524725466], [-80.61959843142245, 40.38545330702448], [-80.61266483831162, 40.38310955686052], [-80.60836796301106, 40.37952068902854], [-80.60758671295645, 40.37471111922275], [-80.60890507231125, 40.36394451842477], [-80.60836796301106, 40.359037291237996], [-80.60187382181942, 40.33664959610195], [-80.60055546336395, 40.323343932176726], [-80.6049499942468, 40.317460142871255], [-80.61456913475774, 40.28642986934295], [-80.6201843694131, 40.28037518186915], [-80.64728397787326, 40.263285338047865], [-80.65675663501071, 40.25537518191908], [-80.6778259707919, 40.216141782816976], [-80.68705448627549, 40.19311932189919], [-80.69435429141743, 40.157548033215164], [-80.70292362722358, 40.13945721337967], [-80.72443241582334, 40.1045451034737], [-80.73534550179346, 40.08000897113709], [-80.73908085299894, 40.060819517906396], [-80.7381042908803, 40.019510924189774], [-80.74130253278565, 39.996781431817624], [-80.74889530557385, 39.982889829901694], [-80.75792850989279, 39.970853697540065], [-80.76537479930755, 39.95373943892395], [-80.76388554088498, 39.947123228254384], [-80.75993046282059, 39.93879803320266], [-80.75868534605189, 39.929398619550625], [-80.76537479930755, 39.91958416607639], [-80.77799686876045, 39.918290221516486], [-80.79142460306298, 39.923978696959296], [-80.80204472138678, 39.9250040877684], [-80.80636600968359, 39.90964764312423], [-80.80355839190622, 39.89934490814096], [-80.79808964242307, 39.88779705728837], [-80.79430546342638, 39.87690838521377], [-80.79674686917264, 39.86868084574439], [-80.81542362699878, 39.85085858055902], [-80.8217468691227, 39.84238690033516], [-80.8280945251422, 39.83086346337814], [-80.83156132169762, 39.82056072839487], [-80.83568729882978, 39.8007853380729], [-80.84110722142111, 39.79048260308963], [-80.86288456377156, 39.77954510322394], [-80.87101444675932, 39.77121990817221], [-80.86532597131651, 39.75915936101569], [-80.84945683036841, 39.74526775999908], [-80.83895878332117, 39.73369549435154], [-80.83566288493415, 39.72036541653074], [-80.84110722142111, 39.7011271355089], [-80.85709843094781, 39.690970884798446], [-80.86159061921171, 39.68682049377077], [-80.86261601002082, 39.68240154899229], [-80.86119999418435, 39.671171080580905], [-80.86159061921171, 39.66636150987574], [-80.87335819692322, 39.6389933458662], [-80.8752380803731, 39.628788268263975], [-80.94415897795443, 39.59807537717688], [-81.05534061927415, 39.530033385232514], [-81.08751835308954, 39.5018839711683], [-81.11066288528389, 39.46894940029455], [-81.12577518917362, 39.45369061123267], [-81.16559452536706, 39.44228924375358], [-81.18331913497008, 39.43061932252368], [-81.21163944720269, 39.40627850225104], [-81.22694706405576, 39.398466001704605], [-81.24703983771832, 39.39175213545269], [-81.26898808003585, 39.38694256384821], [-81.28986210285376, 39.385184752574276], [-81.3101990172708, 39.37888592434592], [-81.34498905590021, 39.35349529936855], [-81.36869511129032, 39.35102947792802], [-81.38844608771677, 39.36216229075711], [-81.40155643867871, 39.38088787727372], [-81.41117558008892, 39.398466001704605], [-81.42052616594981, 39.40627850225104], [-81.46315311902123, 39.40654705690116], [-81.47890018869276, 39.40059002500965], [-81.55426639967459, 39.34421795519444], [-81.56227421318437, 39.32642010300532], [-81.56935429056801, 39.28767498631157], [-81.58097538490608, 39.275321471508676], [-81.58890995493044, 39.280668149715325], [-81.59489139981821, 39.282401548892324], [-81.60087284560535, 39.28064373581975], [-81.60888065821581, 39.275321471508676], [-81.61574100963986, 39.28276776002406], [-81.63751835288969, 39.276151549354495], [-81.66224979908895, 39.27559002525942], [-81.68244022833386, 39.27100018231255], [-81.69806522762815, 39.23708904932016], [-81.74608768939532, 39.19336346285348], [-81.75370487697847, 39.177665220973154], [-81.75509647802005, 39.16526287747979], [-81.752288861142, 39.1282023303732], [-81.75455936871987, 39.10527752503771], [-81.76244511095308, 39.09609783824459], [-81.8125671812304, 39.08008221302367], [-81.81847538533077, 39.07976483058246], [-81.81891483814923, 39.076200377545376], [-81.81434940819861, 39.06304119699365], [-81.81051639961214, 39.056937681728584], [-81.8038269472558, 39.05022381457735], [-81.79640507173667, 39.04480389288534], [-81.79015507219879, 39.042582213098626], [-81.77709354902805, 39.034965025515476], [-81.77523808037307, 39.01719158812125], [-81.78019413535105, 38.98110760313335], [-81.77374882195056, 38.96445721302996], [-81.76449589167203, 38.94883221283635], [-81.7639831971668, 38.93723553329323], [-81.78363651711157, 38.93271893203308], [-81.79450077529054, 38.936136899897974], [-81.8121277284119, 38.95100506393254], [-81.82428593115077, 38.95442303269675], [-81.834783978198, 38.94936932213648], [-81.8408142517763, 38.93752850183887], [-81.84848026715059, 38.91343182232072], [-81.86056522820269, 38.899271665754725], [-81.87999882218787, 38.88315838495146], [-81.90167850985534, 38.87424725190914], [-81.92050175195425, 38.881815610801766], [-81.92763065802842, 38.89275311156683], [-81.92572636068297, 38.89763592395872], [-81.92037968067768, 38.90325115771475], [-81.91740116563125, 38.91655682253929], [-81.91517948584459, 38.91943768200338], [-81.91024784566156, 38.92114666638554], [-81.90529179068358, 38.92383221288628], [-81.9030945247925, 38.92961834571008], [-81.90416874429212, 38.936332212861316], [-81.90648807966113, 38.94165447807171], [-81.90993046322029, 38.94697674418137], [-81.91478886081728, 38.96284588512947], [-81.92401737720019, 38.978544127009854], [-81.93744511060333, 38.99058026027075], [-81.9688904239539, 39.00083416656349], [-81.98432011118416, 39.01206463497488], [-82.00297245511467, 39.0217081893814], [-82.02662968091505, 39.022074400513134], [-82.05836796281125, 39.0032267445186], [-82.09220585321754, 38.968583189262745], [-82.12069706361859, 38.929984556841816], [-82.13649296287991, 38.89917401017243], [-82.14332890040839, 38.85823162668822], [-82.14823612669585, 38.84900311120458], [-82.16119999428429, 38.83142498587438], [-82.17277225993183, 38.80828045547861], [-82.19176640019919, 38.79795330749914], [-82.20870975974759, 38.785990415924914], [-82.21159061921168, 38.76265057256586], [-82.20433964186094, 38.74538983057619], [-82.19525761065017, 38.73169354072428], [-82.18754276658541, 38.71531170527095], [-82.18429569688891, 38.690018735875924], [-82.19069218069956, 38.67573650983206], [-82.19247440766776, 38.66548260353932], [-82.18319706439297, 38.64812420506797], [-82.17909550205576, 38.63540447823408], [-82.17670292410065, 38.6218790883492], [-82.1774597602597, 38.611796080224906], [-82.19274296321714, 38.595316588289904], [-82.2151062435583, 38.59199627510799], [-82.2631042914299, 38.59753826807656], [-82.2771179628237, 38.588285337798084], [-82.28820194696226, 38.566630064026185], [-82.30951542439732, 38.4786906113826], [-82.31698612680827, 38.460966001779525], [-82.33168339177507, 38.44360760330824], [-82.3495300717554, 38.43794354086168], [-82.42450565770991, 38.4330607284698], [-82.50900272769371, 38.409134947120094], [-82.55265507157429, 38.40552166629186], [-82.58898319731668, 38.41875408853036], [-82.58944706403076, 38.41931561082674], [-82.59948124436391, 38.431302916296545], [-82.61593632240334, 38.46352947790308], [-82.62621464169234, 38.47773846315954], [-82.69821171260043, 38.535453307124385], [-82.73661503295739, 38.55447186128737], [-82.78312382240648, 38.567240415912465], [-82.82662968111487, 38.58647869693431], [-82.85587772767497, 38.624833189500066], [-82.88002323588364, 38.69106854147998], [-82.88317264999779, 38.71050213546516], [-82.88307499441544, 38.73035076837323], [-82.88632206411194, 38.74482830738049], [-82.89821171310007, 38.75161541621844], [-82.92416386127314, 38.74834393172705], [-82.98497929066173, 38.72410076793608], [-83.01041874432957, 38.721049010303545], [-83.03097538470621, 38.715873228466705], [-83.04691776734109, 38.70386151000065], [-83.06076054056649, 38.690018735875924], [-83.07496952492363, 38.67944744714197], [-83.1019226500103, 38.67143963543083], [-83.10973514965741, 38.66643475176238], [-83.11522831393552, 38.658841978074804], [-83.1256775331916, 38.63784588487965], [-83.13363651711154, 38.62793377492375], [-83.15153202488301, 38.61894940019465], [-83.17265018935473, 38.61811932234883], [-83.21835331395425, 38.624833189500066], [-83.24181522769061, 38.62327068939078], [-83.25682987689731, 38.616044126834936], [-83.26906132222223, 38.608085142915], [-83.30507206372477, 38.60144451834981], [-83.31273807999838, 38.60405682226451], [-83.32511600959617, 38.61489666654791], [-83.34899296315473, 38.64578045490407], [-83.35614628312447, 38.65278729150026], [-83.36869511089066, 38.659769713301614], [-83.39725956387775, 38.66987713532154], [-83.4113953056488, 38.67263592440838], [-83.44682011095932, 38.67204998641773], [-83.45607304123786, 38.6760294783777], [-83.47252811927729, 38.688846860793944], [-83.49147343085411, 38.69907635319112], [-83.51227421288462, 38.70564373606953], [-83.53429569688888, 38.70740154914216], [-83.60485233806492, 38.68935955709787], [-83.61620487685354, 38.68286541590618], [-83.62086796328589, 38.66416424418452], [-83.63322147808873, 38.64785565041791], [-83.65070194693726, 38.636039244015876], [-83.67081913539477, 38.63103436124675], [-83.714276166312, 38.638529478452654], [-83.75392460343767, 38.659769713301614], [-83.8216736268364, 38.713602720888844], [-83.83698124368942, 38.72981365817378], [-83.85036015020074, 38.74770916594525], [-83.8658630800171, 38.7622355327436], [-83.90844120529738, 38.77173260287731], [-83.94894413506375, 38.786674010397235], [-83.97247929138615, 38.78931072820751], [-84.06185917376183, 38.77566326794545], [-84.08397831424782, 38.77776287735486], [-84.19557499359104, 38.81055096305647], [-84.21757206369978, 38.82346600195439], [-84.22697147825113, 38.84082440042573], [-84.22804569685144, 38.864750181775435], [-84.23153690820175, 38.88525799436093], [-84.23788456422125, 38.903202329923545], [-84.24743046304542, 38.91965740796297], [-84.25787968140219, 38.929300963268815], [-84.27150272776868, 38.93887127508924], [-84.28331913507003, 38.9499796740227], [-84.28842167432077, 38.96401776021145], [-84.2903747985581, 38.98144940036951], [-84.29645389992754, 38.99997967392278], [-84.30690311918357, 39.01689861957561], [-84.32194218138653, 39.02949627513294], [-84.36408085294897, 39.046927916190384], [-84.38861698618496, 39.05395916578283], [-84.40819706444296, 39.05684002524697], [-84.41950077544044, 39.06496990823467], [-84.43009647806997, 39.08320721324225], [-84.44415897815429, 39.10181072848229], [-84.46593632230343, 39.111454282888815], [-84.508612103166, 39.10478924442805], [-84.59474491584518, 39.07405193944544], [-84.63722538464378, 39.07729901004126], [-84.68825077535297, 39.11797283797608], [-84.70304569680144, 39.124491393063295], [-84.70839237680673, 39.12788494703267], [-84.72111210274136, 39.14280193885838], [-84.73004764967925, 39.146219908521914], [-84.74218143942187, 39.143802915771914], [-84.75143436880109, 39.13796795515697], [-84.76759647829482, 39.124491393063295], [-84.82352909619084, 39.097416196700124], [-84.82265018875518, 39.17873943957346], [-84.82179569701378, 39.260111510238005], [-84.82094120527239, 39.34148358000317], [-84.8200622987361, 39.42280682197725], [-84.81923222089029, 39.50415447784684], [-84.81835331435394, 39.58550213551513], [-84.8175232356088, 39.66682537748915], [-84.81664432997184, 39.748173033358796], [-84.81578983823044, 39.829496275332815], [-84.81495976038462, 39.910843932101784], [-84.81408085294896, 39.99219158797138], [-84.8132507751032, 40.073514829945395], [-84.81239628336175, 40.154862485815045], [-84.81154179072104, 40.23623455737891], [-84.81068729897964, 40.3175822132485], [-84.80980839244336, 40.39892986911815], [-84.80890507201144, 40.48027752498774], [-84.80805058027005, 40.56160076786114], [-84.80719608762934, 40.64294842373073], [-84.80634159588794, 40.724271665704805], [-84.80548710324717, 40.80561932247372], [-84.80463261060646, 40.88694256444779], [-84.80377811886507, 40.968290221216705], [-84.80292362712368, 41.049637877086354], [-84.80206913538228, 41.13098553295595], [-84.80123905573782, 41.21230877493002], [-84.80036015010086, 41.29368084649383], [-84.80418398020652, 41.3686552750209], [-84.80418398020652, 41.44809221778161], [-84.80607533630769, 41.53698594104833], [-84.80607533630769, 41.61736856320863], [-84.80607533630769, 41.6968055068686], [-84.73697421638695, 41.69902907253362], [-84.64120190434437, 41.70213520137844], [-84.55630104325854, 41.703170577360254], [-84.4734709350356, 41.70420595334207], [-84.38857007484904, 41.70731208218683], [-84.30315152622194, 41.70731208218683], [-84.22342754684382, 41.710418211031595], [-84.13956206263907, 41.71248896389454], [-84.05466120155319, 41.71663047051976], [-83.96872496538481, 41.71870122248339], [-83.88951867534655, 41.71973659936452], [-83.80254706139777, 41.72284272820934], [-83.72592921176368, 41.72594885705411], [-83.63999297469599, 41.72905498589887], [-83.55457442606888, 41.72905498589887], [-83.41376324217987, 41.735267244487716], [-83.25988034580132, 41.845558740443494], [-83.1308623943533, 41.93802894380099]]}'

    useEffect(() => {
        map.on('remove', () => {
            removed.current = true
        })
    }, [])

    useEffect(() => {
        sourceIdRef.current = id || uuidv4()
        const { current: sourceId } = sourceIdRef
        if (!map.getSource(sourceId)) {
            map.addSource(sourceId, {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    properties: {},
                    geometry: {
                        type: 'Polygon',
                        coordinates: [JSON.parse(jsonString)['coordinates']]
                    }
                }
            })
        }
    }, [id])

    useEffect(() => {
        const layerId = layerIdRef.current || uuidv4()
        layerIdRef.current = layerId
        const { current: sourceId } = sourceIdRef
        if (!map.getLayer(layerId)) {
            map.addLayer({
                id: layerId,
                type: 'line',
                source: sourceId,
                // 'source-layer': variable,
                layout: { visibility: 'visible' },
                paint: {
                    'line-color': color,
                    'line-opacity': opacity,
                    'line-width': width,
                    'line-opacity-transition': { duration: 250, delay: 500 }

                },
            })

            setTimeout(function () {
                map.setPaintProperty(layerId, 'line-opacity', 0)
            }, 750)
            setTimeout(function () {
                map.setPaintProperty(layerId, 'line-opacity', 1);
            }, 1000)
            setTimeout(function () {
                map.setPaintProperty(layerId, 'line-opacity', 0)
            }, 1250)
            setTimeout(function () {
                map.setPaintProperty(layerId, 'line-opacity', 1);
            }, 1500)
            setTimeout(function () {
                map.setPaintProperty(layerId, 'line-opacity', 0)
            }, 1750)
            setTimeout(function () {
                map.setPaintProperty(layerId, 'line-opacity', 1);
            }, 2000)

            return () => {
                if (!removed.current) {
                    if (map.getLayer(layerId)) {
                        map.removeLayer(layerId)
                    }
                }
            }
        }
    }, [])

    useEffect(() => {
        updatePaintProperty(map, layerIdRef, 'line-color', color)
      }, [color])
    
      useEffect(() => {
        updatePaintProperty(map, layerIdRef, 'line-opacity', opacity)
      }, [opacity])
    
      useEffect(() => {
        updatePaintProperty(map, layerIdRef, 'line-width', width)
      }, [width])

    return null
}

export default TempLayer
